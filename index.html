<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMA Player</title>

<style>
html, body {
    margin:0;
    padding:0;
    background:#000;
    height:100%;
    overflow:hidden;
    font-family:Arial;
}

video {
    width:100%;
    height:100%;
    object-fit:contain;
    background:#000;
}

#loader{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    color:white;
}

#skipBtn{
    position:absolute;
    top:20px;
    right:20px;
    background:rgba(0,0,0,.6);
    color:white;
    padding:8px 14px;
    border-radius:6px;
    display:none;
    z-index:10;
    cursor:pointer;
}

#muteBtn{
    position:absolute;
    bottom:20px;
    right:20px;
    background:rgba(0,0,0,.6);
    color:white;
    padding:8px 14px;
    border-radius:6px;
    z-index:10;
    cursor:pointer;
}

#clickLayer{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
}
</style>
</head>

<body>

<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–ª–∞–º—ã...</div>
<div id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
<div id="muteBtn">üîá</div>
<div id="clickLayer"></div>

<video id="adVideo" playsinline muted autoplay></video>

<script>

const tg = window.Telegram?.WebApp;
if(tg) tg.expand();

const video = document.getElementById("adVideo");
const loader = document.getElementById("loader");
const skipBtn = document.getElementById("skipBtn");
const muteBtn = document.getElementById("muteBtn");
const clickLayer = document.getElementById("clickLayer");

let tracking = {};
let clickThroughUrl = null;
let quartilesFired = {};
let skipAvailable = false;

// ===== DEVICE ID =====
function getDeviceId(){
    let id = localStorage.getItem("device_id");
    if(!id){
        id = crypto.randomUUID();
        localStorage.setItem("device_id",id);
    }
    return id;
}

const deviceId = getDeviceId();
const domain = location.hostname;

// ===== VAST URL (–í–ê–ñ–ù–û ‚Äî –∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ) =====

const vastUrl =
`https://ssp.wink.ru/v1/rt/avod/vast?ad_place_type=preroll&age_value=18&broadcast_type=ott&client_id=${deviceId}&client_version=&domain=${domain}&embedded=P5&is_child=false&is_paid=0&location=100001&san=web_vast_code&ad_position=1&content_id=23080&device_type=NCWEB&web_client_type=mobile`;

// ===== Wrapper Resolver =====

async function fetchVast(url, depth=0){

    if(depth>5) throw "wrapper depth";

    const res = await fetch(url);
    const text = await res.text();

    const xml = new DOMParser().parseFromString(text,"text/xml");

    const wrapper = xml.querySelector("Wrapper VASTAdTagURI");

    if(wrapper){
        return fetchVast(wrapper.textContent.trim(), depth+1);
    }

    return xml;
}

// ===== TRACKING =====

function fireTracking(event){

    if(!tracking[event]) return;

    tracking[event].forEach(url=>{
        fetch(url).catch(()=>{});
    });

}

// ===== LOAD VAST =====

async function loadVast(){

    loader.style.display="block";

    try{

        tracking = {};
        clickThroughUrl = null;
        quartilesFired = {};
        skipAvailable = false;
        skipBtn.style.display="none";

        const xml = await fetchVast(vastUrl);

        const mediaFile = xml.querySelector("MediaFile");

        if(!mediaFile){
            loader.innerText="–†–µ–∫–ª–∞–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
            return;
        }

        video.src = mediaFile.textContent.trim();
        video.load();

        xml.querySelectorAll("Tracking").forEach(node=>{
            const ev = node.getAttribute("event");
            if(!tracking[ev]) tracking[ev]=[];
            tracking[ev].push(node.textContent.trim());
        });

        const imp = xml.querySelector("Impression");
        if(imp) tracking.impression=[imp.textContent.trim()];

        const clickNode = xml.querySelector("ClickThrough");
        if(clickNode) clickThroughUrl = clickNode.textContent.trim();

        loader.style.display="none";

        video.muted=true;
        await video.play();

    }catch(e){
        console.log(e);
        loader.innerText="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–ª–∞–º—ã";
    }
}

// ===== VIDEO EVENTS =====

video.addEventListener("play",()=>{
    fireTracking("impression");
    fireTracking("start");
});

video.addEventListener("timeupdate",()=>{

    if(!video.duration) return;

    const p = video.currentTime / video.duration;

    if(video.currentTime>=5 && !skipAvailable){
        skipAvailable=true;
        skipBtn.style.display="block";
    }

    if(p>=0.25 && !quartilesFired.q1){
        quartilesFired.q1=true;
        fireTracking("firstQuartile");
    }

    if(p>=0.5 && !quartilesFired.q2){
        quartilesFired.q2=true;
        fireTracking("midpoint");
    }

    if(p>=0.75 && !quartilesFired.q3){
        quartilesFired.q3=true;
        fireTracking("thirdQuartile");
    }

});

video.addEventListener("ended",()=>{
    fireTracking("complete");
    loader.style.display="block";
    loader.innerText="–†–µ–∫–ª–∞–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
});

// ===== CONTROLS =====

skipBtn.onclick=()=>{
    fireTracking("skip");
    video.pause();
    loader.innerText="–†–µ–∫–ª–∞–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
};

muteBtn.onclick=()=>{
    video.muted=!video.muted;
    muteBtn.innerText = video.muted ? "üîá" : "üîä";
};

// ===== CLICK =====

clickLayer.onclick=()=>{

    if(!clickThroughUrl) return;

    fireTracking("click");

    if(tg) tg.openLink(clickThroughUrl);
    else window.open(clickThroughUrl,"_blank");

};

// ===== START =====

loadVast();

</script>

</body>
</html>
