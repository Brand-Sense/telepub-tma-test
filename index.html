<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMA Ad Player</title>

<style>
html, body {
    margin:0;
    padding:0;
    background:#000;
    height:100%;
    overflow:hidden;
    font-family: Arial;
}

video {
    width:100%;
    height:100%;
    object-fit:contain;
    background:#000;
}

#loader {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    color:white;
}

#skipBtn {
    position:absolute;
    top:20px;
    right:20px;
    background:rgba(0,0,0,.6);
    color:white;
    padding:8px 14px;
    border-radius:6px;
    display:none;
    cursor:pointer;
    z-index:10;
}

#muteBtn {
    position:absolute;
    bottom:20px;
    right:20px;
    background:rgba(0,0,0,.6);
    color:white;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    z-index:10;
}

#clickLayer {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
}
</style>
</head>

<body>

<div id="loader">행햟햡혞향햨햟 햣햨햩햟햪혦...</div>
<div id="skipBtn">쮏혞혜혝햦혝혧</div>
<div id="muteBtn">游댆</div>
<div id="clickLayer"></div>

<video id="adVideo" playsinline muted autoplay></video>

<script>

const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const video = document.getElementById("adVideo");
const loader = document.getElementById("loader");
const skipBtn = document.getElementById("skipBtn");
const muteBtn = document.getElementById("muteBtn");
const clickLayer = document.getElementById("clickLayer");

let tracking = {};
let clickThroughUrl = null;
let quartiles = {};
let skipAvailable = false;

const POSTBACK_URL = "https://yourpostback.com/postback";

// ===== CONFIG =====

const VAST_URL = "PUT_YOUR_VAST_HERE";

const deviceId = localStorage.device_id || crypto.randomUUID();
localStorage.device_id = deviceId;

// ===== LOGGING =====

function logEvent(event, data={}) {

    fetch(POSTBACK_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            event,
            device_id: deviceId,
            timestamp: Date.now(),
            ...data
        })
    }).catch(()=>{});

}

// ===== TRACKING =====

function fireTracking(event){

    if (!tracking[event]) return;

    tracking[event].forEach(url=>{
        fetch(url).catch(()=>{});
    });

    logEvent(event);

}

// ===== TIMEOUT FETCH =====

function fetchTimeout(url, timeout=8000){
    return Promise.race([
        fetch(url),
        new Promise((_,rej)=>setTimeout(()=>rej("timeout"),timeout))
    ]);
}

// ===== WRAPPER SUPPORT =====

async function fetchVast(url, depth=0){

    if(depth>5) throw "wrapper depth";

    const res = await fetchTimeout(url);
    const text = await res.text();

    const xml = new DOMParser().parseFromString(text,"text/xml");

    const wrapper = xml.querySelector("Wrapper VASTAdTagURI");

    if(wrapper){
        return fetchVast(wrapper.textContent.trim(), depth+1);
    }

    return xml;
}

// ===== LOAD AD =====

async function loadAd(){

    loader.style.display="block";

    try{

        tracking = {};
        clickThroughUrl = null;
        quartiles = {};
        skipAvailable = false;
        skipBtn.style.display="none";

        const xml = await fetchVast(VAST_URL);

        const mediaFile = xml.querySelector("MediaFile");

        if(!mediaFile){
            logEvent("no_media");
            loader.innerText="먫왏쥃햟햪햟 향햟쒫왐혣햣햫햟";
            return;
        }

        video.src = mediaFile.textContent.trim();
        video.load();

        xml.querySelectorAll("Tracking").forEach(node=>{
            const ev = node.getAttribute("event");
            if(!tracking[ev]) tracking[ev]=[];
            tracking[ev].push(node.textContent.trim());
        });

        const imp = xml.querySelector("Impression");
        if(imp) tracking.impression=[imp.textContent.trim()];

        const clickNode = xml.querySelector("ClickThrough");
        if(clickNode) clickThroughUrl = clickNode.textContent.trim();

        loader.style.display="none";

        video.muted = true;
        await video.play();

    }catch(e){

        console.log(e);
        loader.innerText="뤰걣쟳쐃쥃 향햟햡혞향햨햦 햣햨햩햟햪혦";

    }
}

// ===== VIDEO EVENTS =====

video.addEventListener("play",()=>{
    fireTracking("impression");
    fireTracking("start");
    logEvent("play");
});

video.addEventListener("timeupdate",()=>{

    if(!video.duration) return;

    const p = video.currentTime / video.duration;

    if(video.currentTime>=5 && !skipAvailable){
        skipAvailable=true;
        skipBtn.style.display="block";
    }

    if(p>=0.25 && !quartiles.q1){
        quartiles.q1=true;
        fireTracking("firstQuartile");
    }

    if(p>=0.5 && !quartiles.q2){
        quartiles.q2=true;
        fireTracking("midpoint");
    }

    if(p>=0.75 && !quartiles.q3){
        quartiles.q3=true;
        fireTracking("thirdQuartile");
    }

});

video.addEventListener("ended",()=>{
    fireTracking("complete");
    logEvent("complete");
    loader.innerText="먫왏쥃햟햪햟 향햟쒫왐혣햣햫햟";
});

// ===== CLICK =====

clickLayer.addEventListener("click",()=>{

    if(!clickThroughUrl) return;

    fireTracking("click");
    logEvent("click",{url:clickThroughUrl});

    if(tg) tg.openLink(clickThroughUrl);
    else window.open(clickThroughUrl,"_blank");

});

// ===== CONTROLS =====

skipBtn.onclick=()=>{
    logEvent("skip");
    video.pause();
    loader.innerText="먫왏쥃햟햪햟 향햟쒫왐혣햣햫햟";
};

muteBtn.onclick=()=>{
    video.muted=!video.muted;
    muteBtn.innerText = video.muted ? "游댆" : "游댉";
    logEvent(video.muted?"muted":"unmuted");
};

// ===== START =====

loadAd();

</script>

</body>
</html>
