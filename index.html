<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMA Ad Player Stable</title>

<style>
html, body {
  margin:0;
  padding:0;
  background:#000;
  height:100%;
  overflow:hidden;
  font-family: Arial;
}

video {
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}

#loader {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  color:#fff;
}

#skipBtn {
  position:absolute;
  top:20px;
  right:20px;
  background:rgba(0,0,0,0.6);
  color:#fff;
  padding:8px 12px;
  border-radius:6px;
  display:none;
  cursor:pointer;
  z-index:10;
}

#muteBtn {
  position:absolute;
  bottom:20px;
  right:20px;
  background:rgba(0,0,0,0.6);
  color:#fff;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  z-index:10;
}

#clickLayer {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}
</style>
</head>
<body>

<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–ª–∞–º—ã...</div>
<div id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
<div id="muteBtn">üîá</div>
<div id="clickLayer"></div>
<video id="adVideo" playsinline muted></video>

<script>
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const video = document.getElementById("adVideo");
const loader = document.getElementById("loader");
const skipBtn = document.getElementById("skipBtn");
const muteBtn = document.getElementById("muteBtn");
const clickLayer = document.getElementById("clickLayer");

let tracking = {};
let clickThroughUrl = null;
let quartilesFired = {};
let skipAvailable = false;

let adQueue = [
  "–í–°–¢–ê–í–¨_–°–í–û–ô_VAST_URL"
];

let currentAdIndex = 0;

// ===== FETCH —Å timeout =====
function fetchWithTimeout(url, timeout = 8000) {
  return Promise.race([
    fetch(url),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Timeout")), timeout)
    )
  ]);
}

// ===== VAST =====
async function fetchVast(url, depth = 0) {

  if (depth > 5) throw new Error("Too many wrappers");

  const res = await fetchWithTimeout(url);
  const text = await res.text();
  const xml = new DOMParser().parseFromString(text, "text/xml");

  const wrapper = xml.querySelector("Wrapper VASTAdTagURI");

  if (wrapper) {
    return fetchVast(wrapper.textContent.trim(), depth + 1);
  }

  return xml;
}

// ===== LOAD AD =====
async function loadAd() {

  loader.style.display = "block";
  skipBtn.style.display = "none";
  skipAvailable = false;

  try {

    const vastUrl = adQueue[currentAdIndex];

    const xml = await fetchVast(vastUrl);

    const mediaFile = xml.querySelector("MediaFile");

    if (!mediaFile) {
      console.log("MediaFile not found");
      playNextAd();
      return;
    }

    video.src = mediaFile.textContent.trim();
    video.load();

    const clickNode = xml.querySelector("ClickThrough");
    if (clickNode) clickThroughUrl = clickNode.textContent.trim();

    loader.style.display = "none";

    await video.play();

  } catch (err) {

    console.error("LOAD ERROR:", err);
    loader.style.display = "none";
    playNextAd();

  }
}

// ===== VIDEO EVENTS =====
video.addEventListener("timeupdate", () => {

  if (!video.duration) return;

  if (video.currentTime >= 5 && !skipAvailable) {
    skipAvailable = true;
    skipBtn.style.display = "block";
  }

});

video.addEventListener("ended", () => {
  playNextAd();
});

video.addEventListener("error", () => {
  console.log("Video error");
  playNextAd();
});

// ===== NEXT AD =====
function playNextAd() {

  currentAdIndex++;

  if (currentAdIndex < adQueue.length) {
    loadAd();
  } else {
    loader.innerText = "–†–µ–∫–ª–∞–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
    loader.style.display = "block";
  }
}

// ===== SKIP =====
skipBtn.addEventListener("click", () => {
  playNextAd();
});

// ===== MUTE =====
muteBtn.addEventListener("click", () => {
  video.muted = !video.muted;
  muteBtn.innerText = video.muted ? "üîá" : "üîä";
});

// ===== CLICK =====
clickLayer.addEventListener("click", () => {
  if (!clickThroughUrl) return;

  if (tg) {
    tg.openLink(clickThroughUrl);
  } else {
    window.open(clickThroughUrl, "_blank");
  }
});

// START
loadAd();

</script>
</body>
</html>
